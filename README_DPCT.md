# Guide for porting Racon to DPC++ using DPCT

## Run DPCT on Racon
One can use the following script to port Racon to DPC++ using DPCT.
```bash
git clone https://github.com/lbcb-sci/racon.git
mkdir racon/build && cd racon/build
cmake -DCMAKE_BUILD_TYPE=Release -Dracon_enable_cuda=ON -Dracon_build_test=ON ..
# Resolve bugs that blocks building
sed -i '3475 s/operator""_format/operator_format/' _deps/genomeworks-src/3rdparty/spdlog/include/spdlog/fmt/bundled/format.h
source /opt/intel/oneapi/setvars.sh
intercept-build make
# Resolve bugs that blocks building
sed -i '46 s/min(t1, min(t2, t3))/t1<(t2<t3?t2:t3)?t1:(t2<t3?t2:t3)/' _deps/genomeworks-src/common/base/include/claraparabricks/genomeworks/utils/mathutils.hpp

# run DPCT or DPCT-Companion
dpct -p=. --in-root=.. --out-root=./dpcpp --extra-arg="-D__CUDA_ARCH__=750" --extra-arg="-I/usr/lib/llvm-10/include/openmp" --extra-arg="-DTHRUST_IGNORE_CUB_VERSION_CHECK=1" &> racon_dpct.log
```

## Resolving warnings
DPCT throws warnings during porting. We can use [DPCT-Companion](https://github.com/DPCT-Companion/DPCT-Companion) to resolve some warnings automatically. For the rest of the warnings, please follow the [official diagnostics reference](https://www.intel.com/content/www/us/en/develop/documentation/intel-dpcpp-compatibility-tool-user-guide/top/diagnostics-reference.html).


## This repository
This repository contains
- The original Racon
- Partially ported Racon generated by DPCT: in `./build/dpcpp`
- Output of DPCT-Companion: in `./migrated_old`
- Manually fixed version of Racon: in `./migrated`

The manually fixed version fixed all the warnings and resolved **some** bugs of DPCT.

### Known bugs of DPCT
We failed to form minimal reproducible examples for these bugs. Still, we will introduce the bugs here for further developers.

- DPCT failed to detect some files as CUDA files, especially those using thrust. For example, `build/_deps/genomeworks-src/common/base/include/claraparabricks/genomeworks/utils/pinned_host_vector.hpp` was not correctly detected, since DPCT left it almost unchanged in `migrated_old/build/_deps/genomeworks-src/common/base/include/claraparabricks/genomeworks/utils/pinned_host_vector.hpp`.

- DPCT fails to handle the conversion from CUDA `min()`/`max()` to `sycl::min()`/`sycl::max()` sometimes. Please check `migrated/build/_deps/genomeworks-src/cudapoa/src/cudapoa_nw.dp.hpp` and `migrated_old/build/_deps/genomeworks-src/cudapoa/src/cudapoa_nw.dp.hpp` for examples. The type conversion applied by DPCT when using these functions were erroneous.

- DPCT sometimes fails to change the name of the header file included in other files, especially when the header file itself does not contain any CUDA code (but wiith the `.cuh` extension). Please check `migrated/build/_deps/genomeworks-src/common/base/include/claraparabricks/genomeworks/utils/allocator.hpp` and `migrated_old/build/_deps/genomeworks-src/common/base/include/claraparabricks/genomeworks/utils/allocator.hpp` for an example.

## Building and running DPC++ Racon
We wrote a Makefile for the DPC++ Racon in `migrated/build/Makefile`. One can make the DPC++ Racon with the `make` command. However, when we run the migrated version, every unit tests related to GPU activities failed. We currently do not have the time (and knowledge) to go deep into the problemã€‚ The reason for the failure is likely to be within the kernel code, i.e., `migrated/build/_deps/genomeworks-src/cudapoa/src/cudapoa_kernels.dp.hpp` based on our initial judgement. 


## Contact Info

Please contact us for any further questions regarding our work.

Tianchen Zhang tianchen.zhang.18@ucl.ac.uk

Yuyi Liang ucabiap@ucl.ac.uk

Yuchen Yang ucabanr@ucl.ac.uk

Choi Lam Wong choi.wong.18@ucl.ac.uk

Yuning Chen yuning.chen.21@ucl.ac.uk

Sundram Goyal sundram.goyal.21@ucl.ac.uk